{% extends "base.html" %}

{% load staticfiles %}

{% load cache %}

{% block title %}
    {{ object.title }}
{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">-->
<link rel="stylesheet" type="text/css" href="{% static 'css/atom-one-dark.css' %}">
{% endblock %}


{% block sidebar_btn %}
<!--<div class="sidebar-btn">
    <button id="offcanvasleft" class="btn btn-xs" type="button" data-toggle="offcanvasleft">side</button>
</div>-->

{% endblock %}

{% block content %}
<div class="content-side">

    <div class="row content-body">

        <div class="col-xs-6 col-md-3" id="sidebarLeft" role="navigation">
            <div id="sidebar-nav">

                <ul class="nav" id="modules">

                <li>
                    <h3>Модулі</h3>
                </li>

                <!-- прогресс бар -->
                <li>
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ lectures_completed }}%;"></div>
                    </div>
                </li>
                <li>
                    {{ lectures_completed|floatformat:"0" }} %
                </li>
                <!-- прогресс бар -->

                <!-- отображаем меню курса и содержание курса -->
                {% if modules %}
                    <li><a href="{% url 'student_course_detail' object.id %}">Curriculum</a></li>
                    <li><a href="{% url 'student_course_about' object.id %}">about course</a></li>
                {% else %}
                    <!-- цикл по модулям -->
                    {% for m in object.modules.all %}
                        <li>
                            <!--<a href="{% url 'student_course_detail_module' object.id m.id %}" data-id="{{ m.id }}" class="module">-->
                            <span>
                                Module <span class="order">{{ m.order|add:1 }}</span>
                            </span>
                            <br />
                            {{ m.title }}
                            <!--</a>-->
                        </li>
                        <!-- цикл по лекциям -->
                        {% for lec in m.lectures.all %}
                            <li>
                                <!-- добавлен id модуля для формирования ссылки на последнюю пройденую лекцию -->
                                <a href="{% url 'student_course_detail_module_lecture' object.id m.id lec.id %}?prev-lecture={{lecture.id}}&prev-module={{module_id}}" data-id="{{ lec.id }}" class="lecture">
                                    {{ lec.title }}
                                </a>
                            </li>
                        {% endfor %}
                    {% empty %}
                        <li>No modules yet.</li>
                    {% endfor %}
                {% endif %}
                </ul><!-- end .nav-->
            </div><!-- end .sidebar-nav -->
        </div> <!-- end div.col-md-3-->

        <div class="col-xs-12 col-md-9" id="main-content">
            <div class="">
                <!--{% if module %}
                    {% cache 300 module_contents module %}
                    {% for lec in module.lectures.all %}
                        {% with item=content.content_object %}
                            {{ item.render }}
                        {% endwith %}
                        <p><a href="{% url 'lecture_detail' object.id module.id lec.id %}">{{ lec.title }}</a></p>
                    {% endfor %}
                    {% endcache %}
                {% endif %}-->

                <!-- отображение лекции -->
                {% if lecture %}
                    <p><button class="btn-hamburger"></button></p>

                    <!-- ссылка на следующую лекцию -->
                    {% if next_lecture %}
                        <p><a href="{% url 'student_course_detail_module_lecture' object.id module_id next_lecture.id %}?prev-lecture={{lecture.id}}&prev-module={{module_id}}" class="btn">next</a></p>
                    {% endif %}

                    <!-- ссылка на страницу окончания курса -->
                    {% if complete_course %}
                        <p><a href="{% url 'course_completed' %}?prev-lecture={{lecture.id}}&prev-module={{module_id}}&prev-course={{object.id}}">next</a></p>
                    {% endif %}

                    {% if questions %}
                        <!-- отображаем вопросы теста -->
                        <div id="content">
                            <h3 id="question"></h3>
                            <div id="choices"></div>
                            <p><button id="submit"></button></p>
                            <p id="score"></p>
                        </div>
                    {% else %}

                        <!-- отображение контента лекции -->
                        {% for content in lecture.contents.all %}
                            {% with item=content.content_object %}
                                {{ item.render }}
                            {% endwith %}
                        {% endfor %}

                    {% endif %}

                {% endif %}

                <!-- отображение содержания курса -->
                {% if modules %}
                    <p><button class="btn-hamburger"></button></p>
                    {% for m in object.modules.all %}
                        <p>{{ m.title }}</p>
                        {% for lec in m.lectures.all %}
                            <p><a href="{% url 'student_course_detail_module_lecture' object.id m.id lec.id %}">{{ lec.title }}</a></p>
                        {% endfor %}
                    {% empty %}

                    {% endfor %}

                {% endif %}
            </div> <!-- end div.module-->
            {% if lecture %}
                {% include "disqus.html" %}
            {% endif %}
        </div> <!-- end div.col-md-9.section-white.courses-->
    </div> <!-- end div.row-->

</div> <!-- end div.content-->



{% endblock %}


{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
<script>
    var slideout = new Slideout({
        'panel': document.getElementById('main-content'),
        'menu': document.getElementById('sidebarLeft'),
        'padding': 256,
        'tolerance': 70
    });

    // Toggle button
    document.querySelector('.btn-hamburger').addEventListener('click', function() {
        slideout.toggle();
    });

    function close(eve) {
        eve.preventDefault();
        slideout.close();
    }

    slideout
        .on('beforeopen', function() {
            this.panel.classList.add('panel-open');
        })
        .on('open', function() {
            this.panel.addEventListener('click', close);
        })
        .on('beforeclose', function() {
            this.panel.classList.remove('panel-open');
            this.panel.removeEventListener('click', close);
        });
</script>

<script type="text/javascript">
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
$('#load-comments').click(function() {
  $(this).hide();
  var d = document, s = d.createElement('script');
  s.src = '//knuba.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})


// do not hide comments button
//function loadComments() {
//var d = document, s = d.createElement('script');
//s.src = '//knuba.disqus.com/embed.js';
//s.setAttribute('data-timestamp', +new Date());
//(d.head || d.body).appendChild(s);
//}


// load disqus comments when page loaded
//(function() { // DON'T EDIT BELOW THIS LINE
//var d = document, s = d.createElement('script');
//s.src = '//knuba.disqus.com/embed.js';
//s.setAttribute('data-timestamp', +new Date());
//(d.head || d.body).appendChild(s);
//})();
</script>

<script type="text/javascript" src="{% static 'js/prism.js' %}"></script>
{% if questions %}

<!-- js код для отображения вопросов теста -->
 <script type="text/javascript">

$(function () {
    // id вопросов для текущей лекции
    var ids = {{ questions }}
    
    //var url = 'api/lectures/' + {{ lecture.id }} + '/'
    //jQuery.get(url, function(data) {
    //    console.log(data);
    //})

// url api-запроса
var questions_url = 'api1/' + ids.join(',');
var quiz_data;
// получаем вопросы
jQuery.ajax({
    type: "get",
    async: false, // без этого data не сохраняется в переменной quiz_data
    url: questions_url,
    dataType: "json",
    success: function(data) {
        quiz_data = data;
    }

});

// контейнеры в которые будут отображатся данные
var content=$('content'),
    questionContainer = $("question"),
    choicesContainer = $("choices"),
    scoreContainer = $("score"),
    submitBtn = $("submit");

var currentQuestion = 0,
    score = 0,
    askingQuestion = true;

var quizLength = ids.length;

// сокращенная функция к document.getElementById
function $(id) {
    return document.getElementById(id);
}

function askQuestion() {
    var choices = quiz_data[currentQuestion].answers,
        choicesHTML = "",
        choicesLength = choices.length;

    // формируем ответы на вопросы
    for (var i = 0; i < choicesLength; i++) {
        choicesHTML += "<input type='radio' name='quiz" +
        currentQuestion + "' id='choice" + (i + 1) + "' " +
        'value="' + choices[i].answer + '">' +
        " <label for='choice" + (i + 1) + "'>" +
        choices[i].answer +
        "</label><br>";
    }

    // выводит текст вопроса
    questionContainer.textContent = "Q" + (currentQuestion + 1) + ". " +
        quiz_data[currentQuestion].question;

    // выводим ответы на вопросы
    choicesContainer.innerHTML = choicesHTML;

    // задаем сообщение о количестве правильных ответов
    if (currentQuestion === 0) {
        scoreContainer.textContent = "Score: " + score + " right answers out of " +
            quizLength + " possible.";
        submitBtn.textContent = "Submit Answer";
    }
  }

function checkAnswer() {
  // ответил ли пользователь на вопрос?
  if (askingQuestion) {
    submitBtn.textContent = "Next Question";
    askingQuestion = false;

    var userpick, // какой ответ выбрал пользователь
        userpick_index,// индекс пользовательского ответа
        correctIndex,// индекс правильного ответа
        radios = document.getElementsByName("quiz" + currentQuestion),
        radiosLength = radios.length;// количество ответов

    for (var i = 0; i < radiosLength; i++) {
        // проверяем какой из ответов был выбран
        if (radios[i].checked) {
            userpick = radios[i].value;
            userpick_index = i;
        }

        // получаем индекс правильного ответа
        if (quiz_data[currentQuestion].answers[i].correct) {
            correctIndex = i;
        }
    }

    // закрашиваем правильный ответ в зеленый, не правильный в красный
    var labels = document.getElementsByTagName('label');
    var labelStyle = labels[correctIndex].style;
    labelStyle.fontWeight = "bold";
    if (userpick_index == correctIndex) {
      score++;
      labelStyle.color = "green";
    } else {
      labelStyle.color = "green";
      labels[userpick_index].style.color = 'red';
    }

    scoreContainer.textContent = "Score: " + score + " right answers out of " +
        quizLength + " possible.";

  } else {
    // указываем что пользователь хочет перейти к след вопросу
    askingQuestion = true;
    submitBtn.textContent = "Submit Answer";
    // если есть след вопрос
    if (currentQuestion < quizLength - 1) {
        currentQuestion++;
        askQuestion();
    } else {
        // отображаем результат ели больше нет вопросов
        showFinalResults();
    }
  }
}

function showFinalResults() {
    content.innerHTML = "<h2>You've completed the quiz!</h2>" +
        "<h2>Below are your results:</h2>" +
        "<h2>" + score + " out of " + quizLength + " questions, " +
        Math.round(score / quizLength * 100) + "%<h2>";
}

window.addEventListener("load", askQuestion, false);
submitBtn.addEventListener("click", checkAnswer, false);
});

</script>

{% else %}
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script type="text/javascript">
    $('pre').each(function(i, block) {
  hljs.highlightBlock(block);
});
</script>
{% endif %}

{% endblock %}